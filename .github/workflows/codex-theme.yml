name: Codex Theme Generator

on:
  issues:
    types: [opened, edited, reopened, labeled]

jobs:
  theme:
    if: contains(github.event.issue.labels.*.name, 'codex-request')
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare branch
        id: branch
        run: |
          BRANCH="codex-theme-${{ github.event.issue.number }}"
          echo "branch_name=$BRANCH" >> "$GITHUB_OUTPUT"
          git checkout -B "$BRANCH"

      - name: Verify OpenAI API key present
        if: ${{ !env.OPENAI_API_KEY }}
        run: |
          echo "OPENAI_API_KEY secret is missing. Add it to the repo or org secrets so codex-action can start the Responses API proxy." >&2
          exit 1

      - name: Generate theme with Codex
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ env.OPENAI_API_KEY }}
          prompt: |
            You are Codex. Generate a refreshed storefront theme for this Next.js + Tailwind ecommerce demo.
            Keep all data fetching and logic intactâ€”modify only styling, layout polish, and copy tone.
            Focus on src/app/globals.css for tokens and src/app/page.tsx for presentation tweaks.
            The requested mood is: "${{ github.event.issue.title }}".
            Maintain accessibility, contrast, and mobile responsiveness.
          output-file: codex-output.md
          safety-strategy: drop-sudo
          sandbox: workspace-write

      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          title: "Codex theme for #${{ github.event.issue.number }}"
          body: |
            Generated by openai/codex-action@v1 from issue #${{ github.event.issue.number }}.

            Final message:
            ${{ steps.codex.outputs.final_message }}
          base: ${{ github.event.repository.default_branch }}
          branch: ${{ steps.branch.outputs.branch_name }}
          commit-message: "chore: codex theme for issue #${{ github.event.issue.number }}"
          labels: codex-request,theme

      - name: Comment with Codex summary
        if: ${{ steps.codex.outputs.final_message != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `Codex summary:\n\n${{ toJson(steps.codex.outputs.final_message) }}`
            });
