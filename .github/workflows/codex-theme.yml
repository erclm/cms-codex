name: Codex Theme Generator

on:
  issues:
    types: [opened, edited, reopened, labeled]

concurrency:
  group: codex-theme-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  theme:
    if: contains(github.event.issue.labels.*.name, 'codex-request')
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}
          token: ${{ secrets.CODEX_PR_TOKEN != '' && secrets.CODEX_PR_TOKEN || github.token }}

      - name: Prepare branch name
        id: branch
        run: |
          BRANCH="codex-theme-${{ github.event.issue.number }}"
          echo "branch_name=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Verify OpenAI API key present
        if: ${{ !env.OPENAI_API_KEY }}
        run: |
          echo "OPENAI_API_KEY secret is missing. Add it to the repo or org secrets so codex-action can start the Responses API proxy." >&2
          exit 1

      - name: Generate theme with Codex
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ env.OPENAI_API_KEY }}
          prompt: |
            You are Codex. Generate a refreshed storefront theme for this Next.js + Tailwind ecommerce demo.
            Keep all data fetching and logic intactâ€”modify only styling, layout polish, and copy tone on the storefront.
            Theme applies to the storefront only (src/app/page.tsx + src/app/globals.css). Do not change admin/auth/dashboard or tests.
            Keep generation quick: minimize diff size, reuse existing tokens, and avoid adding assets or extra routes.
            Preserve existing theme definitions; append a new data-theme block for this request instead of deleting or overwriting prior themes so older themes continue to work.
            Make the theme explicitly toggleable: scope all new design tokens and layout tweaks so they only apply when a single theme flag (class or data-attribute) is turned on, and keep the base look stable when that flag is off.
            Never ship the theme enabled by default in code. Read from the Supabase "themes" table and only set the flag when a theme row is both enabled and status=ready; otherwise keep the base look.
            Focus on src/app/globals.css for tokens and src/app/page.tsx for presentation tweaks that respect that toggle.
            The requested mood is: "${{ github.event.issue.title }}".
            Maintain accessibility, contrast, and mobile responsiveness.
          output-file: codex-output.md
          safety-strategy: drop-sudo
          sandbox: workspace-write

      - name: Create pull request
        id: create_pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.CODEX_PR_TOKEN != '' && secrets.CODEX_PR_TOKEN || github.token }}
          title: "Codex theme for #${{ github.event.issue.number }}"
          body: |
            Generated by openai/codex-action@v1 from issue #${{ github.event.issue.number }}.

            Final message:
            ${{ steps.codex.outputs.final_message }}
          base: ${{ github.event.repository.default_branch }}
          branch: ${{ steps.branch.outputs.branch_name }}
          commit-message: "chore: codex theme for issue #${{ github.event.issue.number }}"
          labels: codex-request,theme

      - name: Comment with branch/PR link
        if: ${{ steps.create_pr.outputs.pull-request-url != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CODEX_PR_TOKEN != '' && secrets.CODEX_PR_TOKEN || github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `Codex created branch \`${{ steps.branch.outputs.branch_name }}\` and opened PR: ${{ steps.create_pr.outputs.pull-request-url }}`
            });

      - name: Comment when PR creation fails
        if: ${{ steps.create_pr.outcome == 'failure' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CODEX_PR_TOKEN != '' && secrets.CODEX_PR_TOKEN || github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `Codex generated changes but could not push/create the PR for branch \`${{ steps.branch.outputs.branch_name }}\`. Please ensure the workflow token can push (set CODEX_PR_TOKEN with repo scope) and rerun.`
            });

      - name: Comment with Codex summary
        if: ${{ steps.codex.outputs.final_message != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `Codex summary:\n\n${{ toJson(steps.codex.outputs.final_message) }}`
            });
