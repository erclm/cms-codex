name: Codex Theme Generator

on:
  issues:
    # Only run when the codex-request label is applied to avoid duplicate runs
    types: [labeled]

concurrency:
  group: codex-theme-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  theme:
    if: contains(github.event.issue.labels.*.name, 'codex-request')
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Prepare branch name
        id: branch
        run: |
          BRANCH="codex-theme-${{ github.event.issue.number }}"
          echo "branch_name=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Create or reset branch
        run: |
          BRANCH="${{ steps.branch.outputs.branch_name }}"
          git checkout -B "$BRANCH"

      - name: Verify OpenAI API key present
        if: ${{ !env.OPENAI_API_KEY }}
        run: |
          echo "OPENAI_API_KEY secret is missing. Add it to the repo or org secrets so codex-action can start the Responses API proxy." >&2
          exit 1

      - name: Generate theme with Codex
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ env.OPENAI_API_KEY }}
          prompt: |
            You are Codex. Generate a refreshed storefront theme for this Next.js + Tailwind ecommerce demo.
            Keep all data fetching and logic intactâ€”modify only styling, layout polish, and copy tone on the storefront.
            Theme applies to the storefront only (src/app/page.tsx + src/app/globals.css). Do not change admin/auth/dashboard or tests.
            Keep generation quick: minimize diff size, reuse existing tokens, and avoid adding assets or extra routes.
            Preserve existing theme definitions; append a new data-theme block for this request instead of deleting or overwriting prior themes so older themes continue to work.
            Make the theme explicitly toggleable: scope all new design tokens and layout tweaks so they only apply when a single theme flag (class or data-attribute) is turned on, and keep the base look stable when that flag is off.
            Never ship the theme enabled by default in code. Read from the Supabase "themes" table and only set the flag when a theme row is both enabled and status=ready; otherwise keep the base look.
            Focus on src/app/globals.css for tokens and src/app/page.tsx for presentation tweaks that respect that toggle.
            The requested mood is: "${{ github.event.issue.title }}".
            Respect the user-provided notes from the issue body:
            ----
            ${{ github.event.issue.body }}
            ----
            Maintain accessibility, contrast, and mobile responsiveness.
          output-file: codex-output.md
          safety-strategy: drop-sudo
          sandbox: workspace-write

      - name: Commit and push branch
        run: |
          BRANCH="${{ steps.branch.outputs.branch_name }}"
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: codex theme for issue #${{ github.event.issue.number }}"
          git push --force-with-lease origin "$BRANCH"

      - name: Comment with branch link
        if: ${{ !cancelled() }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const branch = `${{ toJson(steps.branch.outputs.branch_name) }}`.replace(/"/g, "");
            const defaultBranch = `${{ github.event.repository.default_branch }}`;
            const compareUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/compare/${defaultBranch}...${branch}?expand=1`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `Codex generated changes on branch \`${branch}\`. Open a PR here: ${compareUrl}`
            });

      - name: Comment with Codex summary
        if: ${{ steps.codex.outputs.final_message != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `Codex summary:\n\n${{ toJson(steps.codex.outputs.final_message) }}`
            });
